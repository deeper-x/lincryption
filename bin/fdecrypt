#!/bin/bash
declare -r PASSFILE=${HOME}"/.linpass"
declare -i EXIT_OK=0
declare -i PASSFILE_ERR=101
declare -i GPGMISSING_ERR=102
declare -i FILEMISSING_ERR=103
declare -i INPUTNOTAFILE_ERR=104
declare -i SHREDMISSING_ERR=105
declare -r GPG=$( command -v gpg )
declare -r SHRED=$( command -v shred )

function fdecrypt(){
    #check gpg installation - exit 102
    if [ ! -x ${GPG} ];then
        echo "Missing gpg command"
        return ${GPGMISSING_ERR}
    fi

    #check input parameter - exit 103
    if [ $# -eq 0 ];then
        echo "Missing input file (as a parameter)"
        return ${FILEMISSING_ERR}
    fi

    # declaring assets
    i_file=${1}
    o_file=${1%.*}

    # start reading input
    echo "Reading ${i_file}..."

    #check input is a file - exit 104
    if [ ! -f ${i_file} ];then
        echo "Input parameter is not a file"
        return ${INPUTNOTAFILE_ERR}
    fi

    #check .mypass exists - exit 101 
    if [ ! -f ${PASSFILE} ];then
        echo "Missing password file ${PASSFILE}"
        return ${PASSFILE_ERR}
    fi

    # decryption
    echo "Decrypting file." 
    echo "Waiting for password..."
    # gpg --output README.md --passphrase $( cat /home/deeper-x/.mypass ) --batch --decrypt README.md.gpg 
    ${GPG} --output "${o_file}" --passphrase $( cat ${PASSFILE} ) --decrypt --batch ${i_file}

    echo "Deleting encrypted file..."
    ${SHRED} -zvu -n 3 ${i_file}

    echo -e "Written ${o_file}.\nOperation completed!"
    return ${EXIT_OK}
}

fdecrypt $1